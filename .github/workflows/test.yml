name: Test Suite

# Run on every push to main and on all pull requests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Check out the code
      - uses: actions/checkout@v4

      # 2. Set up Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # 3. Install dependencies
      - run: npm ci

      # 4. Generate Prisma client
      - run: npx prisma generate

      # 5. Set up test database (copy dev.db or create from schema)
      - run: npx prisma db push --force-reset
        env:
          DATABASE_URL: "file:./test.db"

      # 6. Seed the test database
      - run: npx prisma db seed
        env:
          DATABASE_URL: "file:./test.db"

      # 7. Run ESLint
      - run: npm run lint

      # 8. Run production build (needs DB URL for Prisma + dummy AI keys)
      - run: npm run build
        env:
          DATABASE_URL: "file:./test.db"
          TURSO_DATABASE_URL: "file:./test.db"
          OPENAI_API_KEY: "sk-test-dummy-key-for-build"
          GOOGLE_AI_API_KEY: "test-dummy-key-for-build"

      # 9. Run Vitest unit tests
      - run: npx vitest run
        env:
          DATABASE_URL: "file:./test.db"
          TURSO_DATABASE_URL: "file:./test.db"

      # 10. Install Playwright browsers
      - run: npx playwright install chromium --with-deps

      # 11. Run Playwright E2E tests
      - run: npx playwright test
        env:
          DATABASE_URL: "file:./test.db"
          TURSO_DATABASE_URL: "file:./test.db"
          OPENAI_API_KEY: "sk-test-dummy-key-for-ci"
          GOOGLE_AI_API_KEY: "test-dummy-key-for-ci"

      # 12. Upload Playwright test results on failure
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      # 13. Upload failure screenshots
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: test-results/
          retention-days: 7
