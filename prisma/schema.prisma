// AeroVision MVP Database Schema
// This defines all the data structures for tracking aerospace component lifecycles.
// Think of each "model" as a type of record in our system.

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ──────────────────────────────────────────────────────
// A component — the core entity. One record per physical part.
// Example: A single Parker HPC-7 Hydraulic Pump, serial number SN-2019-07842
// ──────────────────────────────────────────────────────
model Component {
  id                  String   @id @default(cuid())
  partNumber          String                          // Real Parker format: "881700-1001"
  serialNumber        String   @unique                // e.g., "SN-2019-07842"
  description         String                          // e.g., "HPC-7 Hydraulic Pump"
  oem                 String                          // e.g., "Parker Aerospace"
  oemDivision         String?                         // e.g., "Hydraulic Systems Division"
  manufactureDate     DateTime
  manufacturePlant    String?                         // e.g., "Irvine, CA"
  totalHours          Float    @default(0)
  totalCycles         Int      @default(0)
  timeSinceOverhaul   Float?   @default(0)            // TSO — hours since last overhaul
  cyclesSinceOverhaul Int?     @default(0)            // CSO — cycles since last overhaul
  status              String   @default("serviceable") // serviceable, in-repair, installed, retired, quarantined
  currentLocation     String?                          // Where the part physically is right now
  currentAircraft     String?                          // Registration of aircraft it's installed on
  currentOperator     String?                          // Airline currently operating it
  isLifeLimited       Boolean  @default(false)         // Is this a life-limited part (LLP)?
  lifeLimit           Int?                             // If LLP, what's the cycle/hour limit?
  imageUrl            String?                          // Photo of the part
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships — one component has many events, alerts, and documents
  events     LifecycleEvent[]
  alerts     Alert[]
  documents  Document[]
  exceptions Exception[]
}

// ──────────────────────────────────────────────────────
// A single event in a component's life.
// Examples: manufacture, install on aircraft, remove for repair, overhaul steps, etc.
// ──────────────────────────────────────────────────────
model LifecycleEvent {
  id            String   @id @default(cuid())
  componentId   String
  component     Component @relation(fields: [componentId], references: [id])
  eventType     String    // "manufacture", "install", "remove", "receiving_inspection",
                          // "teardown", "detailed_inspection", "repair", "reassembly",
                          // "functional_test", "final_inspection", "release_to_service",
                          // "transfer", "retire", "scrap"
  date          DateTime
  facility      String    // Where this happened — e.g., "ST Engineering, Singapore"
  facilityType  String    // "oem", "airline", "mro", "distributor", "broker"
  facilityCert  String?   // FAA Part 145 certificate number
  performer     String    // Who did the work (company or person)
  performerCert String?   // Mechanic's certificate number (A&P, IA, etc.)
  description   String    // What happened — the narrative
  hoursAtEvent  Float?    // Component hours at time of event
  cyclesAtEvent Int?      // Component cycles at time of event
  aircraft      String?   // Aircraft registration (if applicable)
  operator      String?   // Airline (if applicable)
  workOrderRef  String?   // Work order or job card reference number
  cmmReference  String?   // Applicable CMM and revision
  notes         String?   // Additional observations (tribal knowledge!)
  hash          String?   // SHA-256 hash for tamper evidence
  createdAt     DateTime  @default(now())

  // Relationships
  evidence      Evidence[]
  generatedDocs GeneratedDocument[]
  partsConsumed PartConsumed[]
}

// ──────────────────────────────────────────────────────
// A piece of captured evidence — photo, voice note, measurement, document scan
// Attached to a specific lifecycle event
// ──────────────────────────────────────────────────────
model Evidence {
  id              String   @id @default(cuid())
  eventId         String
  event           LifecycleEvent @relation(fields: [eventId], references: [id])
  type            String         // "photo", "video", "voice_note", "document_scan", "measurement"
  fileName        String
  filePath        String
  mimeType        String
  capturedAt      DateTime
  capturedBy      String         // Technician name
  capturedByBadge String?        // Technician ID/badge number
  location        String?        // Facility name
  transcription   String?        // AI transcription of voice note
  structuredData  String?        // AI-structured version (JSON string)
  hash            String         // SHA-256 hash for tamper evidence
  createdAt       DateTime       @default(now())
}

// ──────────────────────────────────────────────────────
// AI-generated formal documents — 8130-3, work orders, findings reports
// These are the paperwork that the AI writes automatically
// ──────────────────────────────────────────────────────
model GeneratedDocument {
  id           String    @id @default(cuid())
  eventId      String
  event        LifecycleEvent @relation(fields: [eventId], references: [id])
  docType      String         // "8130-3", "work_order", "findings_report", "test_results"
  title        String
  content      String         // Full generated document content (JSON)
  pdfPath      String?        // Path to generated PDF
  status       String    @default("draft") // "draft", "approved", "signed"
  approvedBy   String?        // Who approved/signed
  approvedAt   DateTime?
  signatureRef String?        // Electronic signature reference
  hash         String?        // Document hash
  createdAt    DateTime  @default(now())
}

// ──────────────────────────────────────────────────────
// Replacement parts consumed during a repair
// Creates nested traceability — the new part's own 8130-3 links here
// ──────────────────────────────────────────────────────
model PartConsumed {
  id           String   @id @default(cuid())
  eventId      String
  event        LifecycleEvent @relation(fields: [eventId], references: [id])
  partNumber   String         // P/N of the consumed/replacement part
  serialNumber String?        // S/N if serialized
  description  String
  quantity     Int      @default(1)
  sourceDoc    String?        // 8130-3 or CoC reference for the new part
  sourceVendor String?        // Where the part came from
}

// ──────────────────────────────────────────────────────
// An alert — something that needs attention
// Examples: provenance gap, counterfeit suspect, overdue inspection
// ──────────────────────────────────────────────────────
model Alert {
  id          String    @id @default(cuid())
  componentId String
  component   Component @relation(fields: [componentId], references: [id])
  alertType   String    // "provenance_gap", "counterfeit_suspect", "overdue_inspection",
                        // "record_mismatch", "nff_pattern", "life_limit_approaching"
  severity    String    // "info", "warning", "critical"
  title       String
  description String
  status      String    @default("open") // "open", "investigating", "resolved", "dismissed"
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
}

// ──────────────────────────────────────────────────────
// An exception — a detected inconsistency or error in the data.
// Found by the automated exception engine scanning across events and documents.
// Examples: cycles going backward, documentation gaps, missing certificates
// ──────────────────────────────────────────────────────
model Exception {
  id              String    @id @default(cuid())
  componentId     String
  component       Component @relation(fields: [componentId], references: [id])
  exceptionType   String    // "serial_number_mismatch", "part_number_mismatch",
                            // "cycle_count_discrepancy", "hour_count_discrepancy",
                            // "documentation_gap", "missing_release_certificate",
                            // "missing_birth_certificate", "date_inconsistency",
                            // "unsigned_document"
  severity        String    // "info", "warning", "critical"
  title           String    // Human-readable title for the exception
  description     String    // Detailed plain-language explanation of what was found
  evidence        String    // JSON string — the specific data points that triggered this
  status          String    @default("open") // "open", "investigating", "resolved", "false_positive"
  detectedAt      DateTime  @default(now())
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
}

// ──────────────────────────────────────────────────────
// A source document associated with a component
// Legacy docs, CMMs, service bulletins, certificates
// ──────────────────────────────────────────────────────
model Document {
  id            String   @id @default(cuid())
  componentId   String
  component     Component @relation(fields: [componentId], references: [id])
  docType       String    // "cmm", "service_bulletin", "certificate", "legacy_work_order",
                          // "birth_certificate", "8130", "coc"
  title         String
  fileName      String?
  filePath      String?
  extractedText String?   // AI-extracted text from PDF
  aiSummary     String?   // AI-generated summary
  hash          String?   // File hash
  isLegacy      Boolean   @default(false) // Was this digitized from paper?
  createdAt     DateTime  @default(now())
}

// ──────────────────────────────────────────────────────
// Knowledge library entries — captured expertise from experienced mechanics
// This is how tribal knowledge gets preserved
// ──────────────────────────────────────────────────────
model KnowledgeEntry {
  id            String   @id @default(cuid())
  partFamily    String    // e.g., "HPC-7 Hydraulic Pump (881700 series)"
  topic         String    // e.g., "Corrosion on mounting flange"
  expertName    String
  expertYears   Int       // Years of experience
  expertCert    String?   // Certificate type (A&P, IA, etc.)
  description   String    // The insight itself
  audioPath     String?   // Path to audio clip
  transcription String?   // Transcription of the audio
  tags          String    // Comma-separated tags for search
  cmmReference  String?   // Related CMM section
  createdAt     DateTime  @default(now())
}

// ══════════════════════════════════════════════════════
// MOBILE CAPTURE SYSTEM — New models for iPhone app + multi-technician support
// Added for AeroVision Capture PoC (Feb 2026)
// ══════════════════════════════════════════════════════

// ──────────────────────────────────────────────────────
// Organization — the repair station or shop
// A shop's info auto-populates into generated compliance documents
// ──────────────────────────────────────────────────────
model Organization {
  id                    String   @id @default(cuid())
  name                  String                          // e.g., "Precision Aerospace MRO"
  faaRepairStationCert  String?                         // FAA Part 145 certificate number
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  phone                 String?
  email                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  technicians     Technician[]
  captureSessions CaptureSession[]
  auditLog        AuditLogEntry[]
}

// ──────────────────────────────────────────────────────
// Technician — a person who uses the mobile capture app
// Each technician gets their own API key for PoC authentication
// ──────────────────────────────────────────────────────
model Technician {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  firstName       String
  lastName        String
  email           String   @unique
  badgeNumber     String   @unique                      // Used for mobile app login
  role            String   @default("TECHNICIAN")       // TECHNICIAN, SUPERVISOR, ADMIN
  status          String   @default("ACTIVE")           // ACTIVE, INACTIVE
  apiKey          String?  @unique                      // Generated API key for mobile auth
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  captureSessions     CaptureSession[]
  reviewedDocuments   DocumentGeneration2[]  @relation("reviewer")
  auditLog            AuditLogEntry[]
}

// ──────────────────────────────────────────────────────
// CaptureSession — a single capture session from the mobile app
// Created when a technician taps "Start Capture", ended when they tap "Finish"
// ──────────────────────────────────────────────────────
model CaptureSession {
  id              String    @id @default(cuid())
  technicianId    String
  technician      Technician @relation(fields: [technicianId], references: [id])
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  componentId     String?                               // Linked after AI identifies the part
  status          String    @default("capturing")       // capturing, processing, documents_generated, submitted, approved, rejected
  description     String?
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  evidence        CaptureEvidence[]
  documents       DocumentGeneration2[]
  analysis        SessionAnalysis?
}

// ──────────────────────────────────────────────────────
// CaptureEvidence — a piece of evidence captured during a session
// Photos, videos, and audio chunks from the mobile app
// Stored with hash for audit integrity
// ──────────────────────────────────────────────────────
model CaptureEvidence {
  id              String    @id @default(cuid())
  sessionId       String
  session         CaptureSession @relation(fields: [sessionId], references: [id])
  type            String                                // PHOTO, VIDEO, AUDIO_CHUNK
  fileUrl         String                                // URL to file in cloud storage (or local path for PoC)
  fileSize        Int       @default(0)                 // File size in bytes
  fileHash        String?                               // SHA-256 hash for audit integrity
  mimeType        String                                // e.g., "image/jpeg", "video/mp4", "audio/m4a"
  durationSeconds Float?                                // For video and audio
  transcription   String?                               // AI transcription of audio
  aiExtraction    String?                               // JSON — AI-extracted data from images (part numbers, text, etc.)
  gpsLatitude     Float?
  gpsLongitude    Float?
  capturedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())

  // Relationships
  videoAnnotations VideoAnnotation[]
}

// ──────────────────────────────────────────────────────
// VideoAnnotation — timestamped tags from real-time video analysis
// Created by Gemini 2.0 Flash analyzing 2-minute video chunks
// Makes all footage searchable (part numbers spotted, actions observed, tools in use)
// ──────────────────────────────────────────────────────
model VideoAnnotation {
  id          String   @id @default(cuid())
  evidenceId  String
  evidence    CaptureEvidence @relation(fields: [evidenceId], references: [id])
  timestamp   Float                                     // Seconds into the video chunk
  tag         String                                    // e.g., "part_number", "action", "tool", "text", "condition"
  description String                                    // e.g., "Torque wrench applied to engine mount bolt"
  confidence  Float    @default(0)                      // 0-1 confidence score
  rawResponse String?                                   // Full AI response for debugging
  createdAt   DateTime @default(now())
}

// ──────────────────────────────────────────────────────
// SessionAnalysis — deep analysis of an entire capture session
// Created by Gemini 2.5 Flash after session ends, with CMM context loaded
// Contains detailed action log, part identification, procedure verification
// ──────────────────────────────────────────────────────
model SessionAnalysis {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  session         CaptureSession @relation(fields: [sessionId], references: [id])
  actionLog       String                                // JSON — timestamped list of actions observed
  partsIdentified String                                // JSON — all part numbers/serials found
  procedureSteps  String                                // JSON — maintenance steps identified
  anomalies       String   @default("[]")               // JSON — any concerns or anomalies spotted
  confidence      Float    @default(0)                  // 0-1 overall confidence
  modelUsed       String                                // e.g., "gemini-2.5-flash"
  rawResponse     String?                               // Full AI response for debugging
  costEstimate    Float?                                // Estimated API cost in dollars
  processingTime  Int?                                  // Processing time in milliseconds
  createdAt       DateTime @default(now())
}

// ──────────────────────────────────────────────────────
// ComponentManual — CMM (Component Maintenance Manual) PDFs
// Uploaded by admins, linked to part numbers
// Loaded into Gemini's 1M token context window during deep video analysis
// ──────────────────────────────────────────────────────
model ComponentManual {
  id            String   @id @default(cuid())
  partNumber    String                                  // Part number this manual applies to
  title         String                                  // e.g., "HPC-7 Hydraulic Pump CMM Rev. 12"
  fileUrl       String                                  // URL in R2 or local path
  fileSizeBytes Int      @default(0)                    // File size for display
  pageCount     Int?                                    // Number of pages (for context window estimation)
  uploadedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
}

// ──────────────────────────────────────────────────────
// ReferenceData — simple reference info per part number
// Procedures, limits, intervals, specifications — used as AI context
// during document generation (instead of full CMM PDFs for now)
// ──────────────────────────────────────────────────────
model ReferenceData {
  id          String   @id @default(cuid())
  partNumber  String                                    // Which part this reference applies to
  title       String                                    // e.g., "Overhaul Procedure Summary"
  category    String                                    // "procedure", "limit", "interval", "specification"
  content     String                                    // The actual reference text
  source      String                                    // Where this info came from, e.g., "CMM Rev. 12, Section 5.2"
  createdAt   DateTime @default(now())
}

// ──────────────────────────────────────────────────────
// DocumentGeneration2 — AI-generated compliance documents from capture sessions
// Named "2" to avoid conflict with existing GeneratedDocument model
// (existing model is for the web MVP demo; this is for real mobile captures)
// ──────────────────────────────────────────────────────
model DocumentGeneration2 {
  id                  String    @id @default(cuid())
  sessionId           String
  session             CaptureSession @relation(fields: [sessionId], references: [id])
  documentType        String                            // "8130-3", "337", "8010-4", etc. — extensible
  contentJson         String                            // Full form field data as JSON string
  status              String    @default("draft")       // draft, pending_review, approved, rejected
  confidence          Float     @default(0)             // 0-1 overall AI confidence score
  lowConfidenceFields String    @default("[]")          // JSON array of field names AI was uncertain about
  generatedAt         DateTime  @default(now())
  reviewedById        String?
  reviewedBy          Technician? @relation("reviewer", fields: [reviewedById], references: [id])
  reviewedAt          DateTime?
  reviewNotes         String?
  verificationJson    String?                           // JSON — AI verification results (field-level issues, confidence)
  verifiedAt          DateTime?                         // When the independent AI verification completed
  createdAt           DateTime  @default(now())
}

// ──────────────────────────────────────────────────────
// AuditLogEntry — immutable log of all system actions
// Required for FAA compliance — who did what, when, to what
// ──────────────────────────────────────────────────────
model AuditLogEntry {
  id              String    @id @default(cuid())
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  technicianId    String?
  technician      Technician? @relation(fields: [technicianId], references: [id])
  action          String                                // "session_started", "evidence_captured", "document_generated",
                                                        // "document_approved", "document_rejected", "technician_created", etc.
  entityType      String?                               // "CaptureSession", "CaptureEvidence", "DocumentGeneration2", etc.
  entityId        String?                               // ID of the affected record
  metadata        String?                               // JSON — additional context
  timestamp       DateTime  @default(now())
}
